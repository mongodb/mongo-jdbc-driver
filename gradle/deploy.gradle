allprojects {
    task publishMaven {
        group = 'publishing'

        println("Publishing: ${project.name} : ${project.version} as ${project.releaseVersion}")
        if (releaseVersion.endsWith('-SNAPSHOT')) {
            description = 'Publishes snapshots to Sonatype'
            dependsOn ':publishToSonatype'
        } else {
            description = 'Publishes a release and uploads to Sonatype / Maven Central'
            def (boolean passed, String err) = checkReleaseConditions()
            if (passed && project.name == rootProject.name) {
                dependsOn ':closeAndReleaseRepository'
                dependsOn ':publishToSonatype'
                // Make sure we publish to staging first
                project.tasks.getByName('publishToSonatype').finalizedBy(
                        project.tasks.getByName('closeAndReleaseRepository'),
                )
            }
        }
    }
}